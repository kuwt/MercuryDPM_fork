# Template C++ Application

# This template allows you to validate your C++ application.
# The workflow allows running tests and code linting on the default branch.


image:
  name: plath/mercurydpm@sha256:56d96ef477ab3c7921fa14501c0bf04f37d901ee4a6cad1cb061bfd904a0a8e3

pipelines:
  default:
      - step:
          name: Test
          script:
            - pipe: atlassian/slack-notify:2.0.0
              variables:
                WEBHOOK_URL: 'https://hooks.slack.com/services/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'
                MESSAGE: 'Checking commit [${BITBUCKET_COMMIT}] of User ${BITBUCKET_STEP_TRIGGERER_UUID} \n make fullTest running for $BITBUCKET_REPO_SLUG/$BITBUCKET_BRANCH'
            - mkdir MercuryBuild
            - cd MercuryBuild
            - cmake -DCMAKE_BUILD_TYPE=Debug -DMercury_BUILD_USER_DIR=ON -DMercury_BUILD_DOCUMENTATION=ON -G 'Unix Makefiles' ../
            - make fullTest
          artifacts:
            - error_log2.txt
          after-script:
            - if [${BITBUCKET_EXIT_CODE} == 0] ; then
            - pipe: atlassian/slack-notify:2.0.0
              variables:
                WEBHOOK_URL: 'https://hooks.slack.com/services/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'
                MESSAGE: '"build has exited with status $BITBUCKET_EXIT_CODE; $([[ -s error_log.txt ]] && cat error_log.txt || echo All tests passed!)"'
                DEBUG: 'true'
            - fi
            - if [${BITBUCKET_EXIT_CODE} != 0] ; then
            - pipe: atlassian/slack-notify:2.0.0
              variables:
                WEBHOOK_URL: 'https://hooks.slack.com/services/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'
                MESSAGE: '"build has exited with status $BITBUCKET_EXIT_CODE;"'
                DEBUG: 'true'
            - fi